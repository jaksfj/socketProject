<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìŒì•… ì¶”ì²œ ì‹œìŠ¤í…œ</title>
</head>
<body>
<h1>ğŸµ ìŒì•… ì¶”ì²œ ì‹œìŠ¤í…œ</h1>

<p th:text="'í™˜ì˜í•©ë‹ˆë‹¤, ' + ${nickname} + 'ë‹˜!'"></p>

<!-- ìˆ¨ê²¨ì§„ ë‹‰ë„¤ì„ -->
<input type="hidden" id="nickname" th:value="${nickname}" />

<!-- ì¥ë¥´ ì„ íƒ -->
<label for="genreSelect">ì¥ë¥´ ì„ íƒ:</label>
<select id="genreSelect" onchange="loadArtists()">
    <option value="">-- ì¥ë¥´ ì„ íƒ --</option>
</select>
<br><br>

<!-- ê°€ìˆ˜ ì„ íƒ -->
<label for="artistSelect">ê°€ìˆ˜ ì„ íƒ:</label>
<select id="artistSelect" onchange="loadSongs()" disabled>
    <option value="">-- ê°€ìˆ˜ ì„ íƒ --</option>
</select>
<br><br>

<!-- ì¶”ì²œ ê³¡ ë¦¬ìŠ¤íŠ¸ -->
<div id="songList">
    <p>ğŸ§ ì¶”ì²œ ê³¡ ëª©ë¡:</p>
    <ul id="songsUl"></ul>
</div>

<!-- ì €ì¥ ë²„íŠ¼ -->
<button id="saveBtn" onclick="saveSong()" disabled>ğŸµ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì €ì¥</button>

<!-- ì„œë²„ ì‘ë‹µ -->
<p id="responseText" style="color: green;"></p>

<!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ë²„íŠ¼ -->
<br><br>
<button onclick="loadPlaylist()">ğŸ“‚ ë‚´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë³´ê¸°</button>

<!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
<div id="myPlaylist">
    <p>ğŸµ ë‚´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸:</p>
    <ul id="playlistUl"></ul>
</div>

<!-- ì¹œêµ¬ ì¶”ê°€ ì„¹ì…˜ -->
<hr>
<h3>ğŸ‘¥ ì¹œêµ¬ ì¶”ê°€</h3>
<label for="friendName">ì¶”ê°€í•  ì¹œêµ¬ ë‹‰ë„¤ì„:</label>
<input type="text" id="friendName" placeholder="ì˜ˆ: í™ê¸¸ë™" />
<button onclick="addFriend()">â• ì¹œêµ¬ ì¶”ê°€</button>
<p id="friendResponse" style="color: blue;"></p>

<!-- ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ -->
<h3>ğŸ“‹ ì¹œêµ¬ ëª©ë¡</h3>
<button onclick="loadFriends()">ğŸ‘€ ì¹œêµ¬ ëª©ë¡ ë³´ê¸°</button>
<div id="friendListContainer">
    <ul id="friendListUl"></ul>
</div>

<script>
    let selectedSong = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¥ë¥´ ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = function () {
        fetch('/api/genres')
            .then(response => response.json())
            .then(data => {
                const genreSelect = document.getElementById('genreSelect');
                data.forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre;
                    option.textContent = genre;
                    genreSelect.appendChild(option);
                });
            });
    };

    // ì¥ë¥´ ì„ íƒ ì‹œ í•´ë‹¹ ê°€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadArtists() {
        const genre = document.getElementById('genreSelect').value;
        const artistSelect = document.getElementById('artistSelect');
        artistSelect.innerHTML = '<option value="">-- ê°€ìˆ˜ ì„ íƒ --</option>';
        document.getElementById('songsUl').innerHTML = '';
        document.getElementById('saveBtn').disabled = true;
        selectedSong = null;

        if (!genre) {
            artistSelect.disabled = true;
            return;
        }

        fetch(`/api/artists?genre=${genre}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(artist => {
                    const option = document.createElement('option');
                    option.value = artist;
                    option.textContent = artist;
                    artistSelect.appendChild(option);
                });
                artistSelect.disabled = false;
            });
    }

    // ê°€ìˆ˜ ì„ íƒ ì‹œ í•´ë‹¹ ë…¸ë˜ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadSongs() {
        const genre = document.getElementById('genreSelect').value;
        const artist = document.getElementById('artistSelect').value;
        const songsUl = document.getElementById('songsUl');
        songsUl.innerHTML = '';
        document.getElementById('saveBtn').disabled = true;
        selectedSong = null;

        if (!artist) return;

        fetch(`/api/songs?genre=${genre}&artist=${artist}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(song => {
                    const li = document.createElement('li');
                    li.textContent = song.title;
                    li.style.cursor = "pointer";
                    li.onclick = function () {
                        document.querySelectorAll('#songsUl li').forEach(el => el.style.fontWeight = 'normal');
                        this.style.fontWeight = 'bold';
                        selectedSong = song.title;
                        document.getElementById('saveBtn').disabled = false;
                    };
                    songsUl.appendChild(li);
                });
            });
    }

    // ì„ íƒí•œ ê³¡ ì €ì¥ ìš”ì²­
    function saveSong() {
        const nickname = document.getElementById('nickname').value;
        const songTitle = selectedSong;

        fetch('/api/playlist/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nickname: nickname, song: songTitle })
        })
            .then(res => res.text())
            .then(result => {
                document.getElementById('responseText').textContent = result;
            });
    }

    // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
    function loadPlaylist() {
        const nickname = document.getElementById('nickname').value;
        const playlistUl = document.getElementById('playlistUl');
        playlistUl.innerHTML = '';

        fetch(`/api/playlist?nickname=${nickname}`)
            .then(res => res.json())
            .then(data => {
                if (data.length === 0) {
                    playlistUl.innerHTML = '<li>(ì €ì¥ëœ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤)</li>';
                } else {
                    data.forEach(song => {
                        const li = document.createElement('li');
                        li.textContent = song;
                        playlistUl.appendChild(li);
                    });
                }
            });
    }

    // ì¹œêµ¬ ì¶”ê°€
    function addFriend() {
        const nickname = document.getElementById('nickname').value;
        const friendName = document.getElementById('friendName').value;

        if (!friendName) {
            alert("ì¹œêµ¬ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const command = `/addfriend ${friendName}`;

        fetch('/command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ nickname: nickname, command: command })
        })
            .then(res => res.text())
            .then(result => {
                document.getElementById('friendResponse').textContent = result;
            });
    }

    // ë¸Œë¼ìš°ì €ë¥¼ ì¢…ë£Œí•˜ë©´ í•´ë‹¹ ì†Œì¼“ ìœ ì € ì—°ê²°í•´ì œ
    window.addEventListener('beforeunload', function () {
        const nickname = document.getElementById('nickname').value;
        if (!nickname) return;

        navigator.sendBeacon('/command', new URLSearchParams({
            nickname: nickname,
            command: '/disconnect'
        }));
    });

    // ì¹œêµ¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function loadFriends() {
        const nickname = document.getElementById('nickname').value;

        fetch('/command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                nickname: nickname,
                command: '/friendlist'
            })
        })
            .then(res => res.text())
            .then(result => {
                const ul = document.getElementById('friendListUl');
                ul.innerHTML = '';

                const lines = result.split('\n');
                ul.innerHTML = '';

                const friendLines = lines.filter(line => line.startsWith("- "));
                if (friendLines.length === 0) {
                    ul.innerHTML = '<li>(ì¹œêµ¬ ì—†ìŒ)</li>';
                } else {
                    friendLines.forEach(friend => {
                        const name = friend.replace("- ", "").trim(); // ì •í™•í•œ ì¹œêµ¬ ì´ë¦„ë§Œ ì¶”ì¶œ ("-"ë¡œ ì‹œì‘)
                        const li = document.createElement('li');
                        li.innerHTML = `
            <strong>${name}</strong>
            <button onclick="showSendUI('${name}')">ìŒì•…ê³¼ ë©”ì„¸ì§€ ë³´ë‚´ê¸°!</button>
            <div id="sendBox-${name}" style="display:none; margin-top:10px;">
                <label>ê³¡ ì„ íƒ:</label>
                <select id="songSelect-${name}"></select><br>
                <label>ë©”ì„¸ì§€:</label>
                <input type="text" id="msgInput-${name}" placeholder="ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/><br>
                <button onclick="sendMusicMessage('${name}')">ì „ì†¡</button>
            </div>
        `;
                        ul.appendChild(li);
                    });
                }
            });
    }

    // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ë©”ì„œë“œ -> loadFriends()ì—ì„œ ì‚¬ìš©
    function showSendUI(friend) {
        const box = document.getElementById(`sendBox-${friend}`);
        box.style.display = box.style.display === 'none' ? 'block' : 'none';

        const nickname = document.getElementById('nickname').value;
        const songSelect = document.getElementById(`songSelect-${friend}`);
        songSelect.innerHTML = '';

        fetch(`/api/playlist?nickname=${nickname}`)
            .then(res => res.json())
            .then(data => {
                if (data.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = '(í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì—†ìŒ)';
                    option.disabled = true;
                    songSelect.appendChild(option);
                } else {
                    data.forEach(song => {
                        const option = document.createElement('option');
                        option.value = song;
                        option.textContent = song;
                        songSelect.appendChild(option);
                    });
                }
            });
    }

    // ìŒì•…ê³¼ ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•˜ëŠ” ë©”ì„œë“œ
    function sendMusicMessage(friend) {
        const nickname = document.getElementById('nickname').value;
        const song = document.getElementById(`songSelect-${friend}`).value;
        const message = document.getElementById(`msgInput-${friend}`).value;

        if (!song || !message) {
            alert("ê³¡ê³¼ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const command = `/sendmusic ${friend} ${song} ${message}`;

        fetch('/command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ nickname: nickname, command: command })
        })
            .then(res => res.text())
            .then(result => {
                if (result.includes("[OPEN_CHAT]")) {
                    openChatRoom(friend, song, message, nickname); // ì•„ë˜ì— ì •ì˜í•  í•¨ìˆ˜
                } else {
                    alert(result);
                }
            });
    }

    // sendMusicMessage ë¥¼ ë³´ë‚´ë©´ ë§Œë“¤ì–´ì§€ëŠ” ì±„íŒ…ë°©
    function openChatRoom(friend, song, message, nickname) {
        const chatWindow = window.open("", `chat-${friend}`, "width=400,height=600");

        chatWindow.document.write(`
        <html><head><title>${friend}ì™€ì˜ ì±„íŒ…</title></head><body>
        <h3>ğŸµ ${friend}ë‹˜ê³¼ì˜ ì±„íŒ…ë°©</h3>
        <div id="chatLog" style="height:300px;overflow:auto;border:1px solid #ccc;padding:5px;">
            <div><strong>ë‚˜:</strong> ${song} (${message})</div>
        </div>
        <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width:70%;">
        <button onclick="sendMessage()">ì „ì†¡</button>

        <script>
        const nickname = "${nickname}";
        const friend = "${friend}";
        function sendMessage() {
            const msg = document.getElementById('chatInput').value;
            fetch('/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    nickname: nickname,
                    command: '/chat ' + friend + ' ' + msg
                })
            }).then(res => res.text()).then(res => {
                const log = document.getElementById('chatLog');
                log.innerHTML += '<div><strong>ë‚˜:</strong> ' + msg + '</div>';
                document.getElementById('chatInput').value = '';
            });
        }
        <\/script>
        </body></html>
    `);
    }
</script>
</body>
</html>

