<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìŒì•… ì¶”ì²œ ì‹œìŠ¤í…œ</title>
</head>
<body>
<h1>ğŸµ ìŒì•… ì¶”ì²œ ì‹œìŠ¤í…œ</h1>

<p th:text="'í™˜ì˜í•©ë‹ˆë‹¤, ' + ${nickname} + 'ë‹˜!'"></p>

<!-- ìˆ¨ê²¨ì§„ ë‹‰ë„¤ì„ -->
<input type="hidden" id="nickname" th:value="${nickname}" />

<!-- ì¥ë¥´ ì„ íƒ -->
<label for="genreSelect">ì¥ë¥´ ì„ íƒ:</label>
<select id="genreSelect" onchange="loadArtists()">
    <option value="">-- ì¥ë¥´ ì„ íƒ --</option>
</select>
<br><br>

<!-- ê°€ìˆ˜ ì„ íƒ -->
<label for="artistSelect">ê°€ìˆ˜ ì„ íƒ:</label>
<select id="artistSelect" onchange="loadSongs()" disabled>
    <option value="">-- ê°€ìˆ˜ ì„ íƒ --</option>
</select>
<br><br>

<!-- ì¶”ì²œ ê³¡ ë¦¬ìŠ¤íŠ¸ -->
<div id="songList">
    <p>ğŸ§ ì¶”ì²œ ê³¡ ëª©ë¡:</p>
    <ul id="songsUl"></ul>
</div>

<!-- ì €ì¥ ë²„íŠ¼ -->
<button id="saveBtn" onclick="saveSong()" disabled>ğŸµ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì €ì¥</button>

<!-- ì„œë²„ ì‘ë‹µ -->
<p id="responseText" style="color: green;"></p>

<script>
    let selectedSong = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¥ë¥´ ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = function () {
        fetch('/genres')
            .then(response => response.json())
            .then(data => {
                const genreSelect = document.getElementById('genreSelect');
                data.forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre;
                    option.textContent = genre;
                    genreSelect.appendChild(option);
                });
            });
    };

    // ì¥ë¥´ ì„ íƒ ì‹œ í•´ë‹¹ ê°€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadArtists() {
        const genre = document.getElementById('genreSelect').value;
        const artistSelect = document.getElementById('artistSelect');
        artistSelect.innerHTML = '<option value="">-- ê°€ìˆ˜ ì„ íƒ --</option>';
        document.getElementById('songsUl').innerHTML = '';
        document.getElementById('saveBtn').disabled = true;
        selectedSong = null;

        if (!genre) {
            artistSelect.disabled = true;
            return;
        }

        fetch(`/artists?genre=${genre}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(artist => {
                    const option = document.createElement('option');
                    option.value = artist;
                    option.textContent = artist;
                    artistSelect.appendChild(option);
                });
                artistSelect.disabled = false;
            });
    }

    // ê°€ìˆ˜ ì„ íƒ ì‹œ í•´ë‹¹ ë…¸ë˜ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadSongs() {
        const genre = document.getElementById('genreSelect').value;
        const artist = document.getElementById('artistSelect').value;
        const songsUl = document.getElementById('songsUl');
        songsUl.innerHTML = '';
        document.getElementById('saveBtn').disabled = true;
        selectedSong = null;

        if (!artist) return;

        fetch(`/songs?genre=${genre}&artist=${artist}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(song => {
                    const li = document.createElement('li');
                    li.textContent = song.title;
                    li.style.cursor = "pointer";
                    li.onclick = function () {
                        document.querySelectorAll('#songsUl li').forEach(el => el.style.fontWeight = 'normal');
                        this.style.fontWeight = 'bold';
                        selectedSong = song.title;
                        document.getElementById('saveBtn').disabled = false;
                    };
                    songsUl.appendChild(li);
                });
            });
    }

    // ì„ íƒí•œ ê³¡ ì €ì¥ ìš”ì²­
    function saveSong() {
        const nickname = document.getElementById('nickname').value;
        const songTitle = selectedSong;

        fetch('/playlist/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nickname: nickname, song: songTitle })
        })
            .then(res => res.text())
            .then(result => {
                document.getElementById('responseText').textContent = result;
            });
    }
</script>
</body>
</html>

